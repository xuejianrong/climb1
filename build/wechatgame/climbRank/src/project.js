window.__require=function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c=i.split("/");if(c=c[c.length-1],!t[c]){var l="function"==typeof __require&&__require;if(!s&&l)return l(c,!0);if(o)return o(c,!0);throw new Error("Cannot find module '"+i+"'")}}var u=a[i]={exports:{}};t[i][0].call(u.exports,function(e){return n(t[i][1][e]||e)},u,u.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof __require&&__require,i=0;i<r.length;i++)n(r[i]);return n}({launch:[function(e,t,a){"use strict";cc._RF.push(t,"e53e6YiUd9FJLf8yIQu1n47","launch"),cc.Class({extends:cc.Component,properties:{content:cc.Node,prefab:cc.Prefab,selfBlock:cc.Node,selfRankNum:cc.Label,selfName:cc.Label,selfScore:cc.Label,selfHead:cc.Sprite,keyName:"friendRank",list:[],openid:"",user:"",shareTicket:""},start:function(){var e=this;wx.onMessage(function(t){console.log("onMessage",t),0===t.type?(e.selfScore.string=t.data.score,t.data.score>e.getKVDataVal(e.user.KVDataList,e.keyName)&&(e.content.removeAllChildren(),wx.setUserCloudStorage({KVDataList:[{key:e.keyName,value:JSON.stringify({wxgame:t.data})}],success:function(t){console.log("setUserCloudStorage","success",t),e.getRankList(e.user)},fail:function(e){console.log("setUserCloudStorage","fail")},complete:function(e){console.log("setUserCloudStorage","ok")}}))):1===t.type?(e.openid=t.openid,wx.getUserInfo({openIdList:["selfOpenId"],lang:"zh_CN",success:function(t){console.log("\u5f53\u524d\u7528\u6237\u4fe1\u606f",t.data);var a=t.data[0];e.shareTicket?e.getGroupRankList(a):e.getRankList(a)},fail:function(e){console.log("\u83b7\u53d6\u4fe1\u606f\u5931\u8d25",e)}})):2===t.type&&(e.shareTicket=t.shareTicket)})},getRankList:function(e){var t=this;wx.getFriendCloudStorage({keyList:[this.keyName],success:function(a){var r=a.data.filter(function(e){return parseInt(t.getTimeVal(e.KVDataList[0].value),10)>t.getWeekStartDate().getTime()});r.sort(function(e,a){return 0==e.KVDataList.length&&0==a.KVDataList.length?0:0==e.KVDataList.length?1:0==a.KVDataList.length?-1:t.getScoreVal(a.KVDataList[0].value)-t.getScoreVal(e.KVDataList[0].value)}),console.log("\u5173\u7cfb\u94fe\u597d\u53cb\u6392\u884c\u699c\uff1a",r);for(var n=0;n<r.length;n++){var o=r[n];t.createUserBlock(o,n+1),o.openid===t.openid&&(t.user=o,t.user.rankNum=n+1)}t.user||(t.user=e),t.createSelfBlock(t.user),t.list=r},fail:function(e){console.error(e)}})},getGroupRankList:function(e){var t=this;wx.getGroupCloudStorage({shareTicket:this.shareTicket,keyList:[this.keyName],success:function(a){var r=a.data.filter(function(e){return parseInt(t.getTimeVal(e.KVDataList[0].value),10)>t.getWeekStartDate().getTime()});r.sort(function(e,a){return 0==e.KVDataList.length&&0==a.KVDataList.length?0:0==e.KVDataList.length?1:0==a.KVDataList.length?-1:t.getScoreVal(a.KVDataList[0].value)-t.getScoreVal(e.KVDataList[0].value)}),console.log("\u5173\u7cfb\u94fe\u7fa4\u6392\u884c\u699c\uff1a",r);for(var n=0;n<r.length;n++){var o=r[n];t.createUserBlock(o,n+1),o.openid===t.openid&&(t.user=o,t.user.rankNum=n+1)}t.user||(t.user=e),t.createSelfBlock(t.user),t.list=r},fail:function(e){console.error(e)}})},createUserBlock:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,a=this.createPrefab(),r=e.nickName?e.nickName:e.nickname,n=e.avatarUrl,o=a.getChildByName("userName").getComponent(cc.Label),i=a.getChildByName("rankNum").getComponent(cc.Label),s=a.getChildByName("score").getComponent(cc.Label),c=a.getChildByName("mask").children[0].getComponent(cc.Sprite);o.string=r,i.string=t,s.string=this.getKVDataVal(e.KVDataList,"score"),cc.loader.load({url:n,type:"png"},function(e,t){e&&console.error(e),c.spriteFrame=new cc.SpriteFrame(t)})},createSelfBlock:function(e){var t=this;this.selfName.string=e.nickName?e.nickName:e.nickname,cc.loader.load({url:e.avatarUrl,type:"png"},function(e,a){e&&console.error(e),t.selfHead.spriteFrame=new cc.SpriteFrame(a)})},createPrefab:function(){var e=cc.instantiate(this.prefab);return e.parent=this.content,e},getKVDataVal:function(e,t){var a=(e||[]).filter(function(e){return e.key=t});return a.length>0?this.getScoreVal(a[0].value):0},getScoreVal:function(e){return JSON.parse(e).wxgame.score},getTimeVal:function(e){return JSON.parse(e).wxgame.update_time},getWeekStartDate:function(){var e=new Date,t=e.getDay(),a=e.getDate(),r=e.getMonth(),n=e.getFullYear();return new Date(n,r,a-t+1)}}),cc._RF.pop()},{}]},{},["launch"]);